{

TFile *e = new TFile("sandbox/zz-latest/bkgd.root");
TFile *m = new TFile("sandbox/zz-latest/bkgd.root");
TString LEleZ = "z1Mass>70&&z1Mass<110&&z1l1CiCTight&9==9&&z1l2CiCTight&9==9&&z1l1MissHits<2&&z1l2MissHits<2&&z1l1RelPfIsoRho<0.2&&z1l2RelPfIsoRho<0.2&&z1l1Pt>20&&z1l2Pt>10";
TString LMuZ = "z1Mass>70&&z1Mass<110&&z1l1RelPfIsoRho<0.25&&z1l2RelPfIsoRho<0.25&&z1l1Pt>20&&z1l2Pt>10";
TString STTZt1n = "&&z2l1Pt>15&&z2l2Pt>15&&z2l1EleVeto&&z2l2EleVeto&&z2l1MediumIso&&z2l1MuVeto&&z2l2MuVeto&&z2Mass>30&&z2Mass<80&&(z2l1Pt+z2l2Pt)>40&&z2Charge!=0";
TString STTZt2n = "&&z2l1Pt>15&&z2l2Pt>15&&z2l1EleVeto&&z2l2EleVeto&&z2l2MediumIso&&z2l1MuVeto&&z2l2MuVeto&&z2Mass>30&&z2Mass<80&&(z2l1Pt+z2l2Pt)>40&&z2Charge!=0";
TString STTZt1nVL = "&&z2l1Pt>15&&z2l2Pt>15&&z2l1EleVeto&&z2l2EleVeto&&z2l1LooseIso&&z2l1MuVeto&&z2l2MuVeto&&z2Mass>30&&z2Mass<80&&(z2l1Pt+z2l2Pt)>40&&z2Charge!=0";
TString STTZt2nVL = "&&z2l1Pt>15&&z2l2Pt>15&&z2l1EleVeto&&z2l2EleVeto&&z2l1LooseIso&&z2l1MuVeto&&z2l2MuVeto&&z2Mass>30&&z2Mass<80&&(z2l1Pt+z2l2Pt)>40&&z2Charge!=0";
TString STTZtd  = "&&z2l1Pt>15&&z2l2Pt>15&&z2l1EleVeto&&z2l2EleVeto&&z2l1MuVeto&&z2l2MuVeto&&z2Mass>30&&z2Mass<80&&(z2l1Pt+z2l2Pt)>40&&z2Charge!=0";
TString STTZcuts = "&&z2l1Pt>15&&z2l2Pt>15&&z2l1EleVeto&&z2l2EleVeto&&!z2l1MediumIso&&!z2l2MediumIso&&z2l1MuVeto&&z2l2MuVeto&&z2Mass>30&&z2Mass<80&&(z2l1Pt+z2l2Pt)>40&&z2Charge==0";
TString SMTZcuts = "&&z2l2EleVeto&&!z2l2LooseIso&&z2l2MuVetoTight&&z2l1RelPfIsoRho<0.2&&z2l2Pt>15&&z2l1Pt>10&&z2Charge==0&&z2Mass>30&&z2Mass<80&&(z2l2Pt+z2l1Pt)>30";
TString SETZcuts = "&&z2l2EleVeto&&z2l1CiCTight&9==9&&!z2l2LooseIso&&z2l2Pt>15&&z2l1Pt>10&&z2l1RelPfIsoRho<0.05&&z2l1MissHits==0&&z2l2MuVeto&&z2Charge==0&&z2Mass>30&&z2Mass<80&&(z2l1Pt+z2l2Pt)>30";
gROOT->ProcessLine(".!mkdir FitPlots");

////////////////////////////////////// Measure fake rate and apply fit ////////////////////////////////////////////////////
//Two channels combined for increased statistics: EETT, MMTT

e->cd();
eleEleTauTauEventTreeID->cd();
TGraphAsymmErrors *tt = new TGraphAsymmErrors();
TGraphAsymmErrors *lt = new TGraphAsymmErrors();
TCanvas *C = new TCanvas();
TH1F *n1 = new TH1F("n1", "n1", 10, 0,100);
TH1F *d1 = new TH1F("d1", "d1", 10, 0,100);
TH1F *n1VL = new TH1F("n1VL", "n1VL", 10, 0,100);
TH1F *d1VL = new TH1F("d1VL", "d1VL", 10, 0,100);
eventTree->Draw("z2l1Pt>>n1",LEleZ+STTZt1n);
eventTree->Draw("z2l2Pt>>n2(10,0,100)",LEleZ+STTZt2n);
eventTree->Draw("z2l1Pt>>n1VL",LEleZ+STTZt1nVL);
eventTree->Draw("z2l2Pt>>n2VL(10,0,100)",LEleZ+STTZt2nVL);
n1->Add(n1,n2);
n1VL->Add(n1VL,n2VL);
eventTree->Draw("z2l1Pt>>d1",LEleZ+STTZtd);
eventTree->Draw("z2l2Pt>>d2(10,0,100)",LEleZ+STTZtd);
eventTree->Draw("z2l1Pt>>d1VL",LEleZ+STTZtd);
eventTree->Draw("z2l2Pt>>d2VL(10,0,100)",LEleZ+STTZtd);
d1->Add(d1,d2);
d1VL->Add(d1VL,d2VL);
m->cd();
muMuTauTauEventTreeID->cd();
eventTree->Draw("z2l1Pt>>n3(10,0,100)",LMuZ+STTZt1n);
eventTree->Draw("z2l1Pt>>n3VL(10,0,100)",LMuZ+STTZt1nVL);
n1->Add(n1,n3);
n1VL->Add(n1VL,n3VL);
eventTree->Draw("z2l2Pt>>n4(10,0,100)",LMuZ+STTZt2n);
eventTree->Draw("z2l2Pt>>n4VL(10,0,100)",LMuZ+STTZt2nVL);
n1->Add(n1,n4);
n1VL->Add(n1VL,n4VL);
eventTree->Draw("z2l1Pt>>d3(10,0,100)",LMuZ+STTZtd);
eventTree->Draw("z2l1Pt>>d3VL(10,0,100)",LMuZ+STTZtd);
d1->Add(d1,d3);
d1VL->Add(d1VL,d3VL);
eventTree->Draw("z2l2Pt>>d4(10,0,100)",LMuZ+STTZtd);
eventTree->Draw("z2l2Pt>>d4VL(10,0,100)",LMuZ+STTZtd);
d1->Add(d1,d4);
d1VL->Add(d1VL,d4VL);
tt->BayesDivide(n1,d1);
tt->GetXaxis()->SetTitle("#tau p_{T} GeV");
tt->GetYaxis()->SetTitle("Fake Rate");
tt->Draw("AP");
TF1 *myfit1 = new TF1("myfit1","[0] + [1]*exp([2]*x)", 0, 100);
myfit1->SetParameter(0, 0);
myfit1->SetParameter(1, 0);
myfit1->SetParameter(2, 0);
tt->Fit("myfit1","WR");
C->SaveAs("FitPlots/tautau.png");
double c0 = myfit1->GetParameter(0);
double c1 = myfit1->GetParameter(1);
double c2 = myfit1->GetParameter(2);
double e0 = myfit1->GetParError(0);
double e1 = myfit1->GetParError(1);
double e2 = myfit1->GetParError(2);
lt->BayesDivide(n1VL,d1VL);
lt->GetXaxis()->SetTitle("#tau p_{T} GeV");
lt->GetYaxis()->SetTitle("Fake Rate");
lt->Draw("AP");
TF1 *myfit2 = new TF1("myfit2","[0] + [1]*exp([2]*x)", 0, 100);
myfit2->SetParameter(0, 0);
myfit2->SetParameter(1, 0);
myfit2->SetParameter(2, 0);
lt->Fit("myfit2","WR");
C->SaveAs("FitPlots/tautauVL.png");
double c0VL = myfit2->GetParameter(0);
double c1VL = myfit2->GetParameter(1);
double c2VL = myfit2->GetParameter(2);
double e0VL = myfit2->GetParError(0);
double e1VL = myfit2->GetParError(1);
double e2VL = myfit2->GetParError(2);
std::ostringstream S0;
std::ostringstream S1;
std::ostringstream S2;
std::ostringstream E0;
std::ostringstream E1;
std::ostringstream E2;
std::ostringstream S0VL;
std::ostringstream S1VL;
std::ostringstream S2VL;
std::ostringstream E0VL;
std::ostringstream E1VL;
std::ostringstream E2VL;
S0 << c0;
S1 << c1;
S2 << c2;
E0 << e0;
E1 << e1;
E2 << e2;
S0VL << c0VL;
S1VL << c1VL;
S2VL << c2VL;
E0VL << e0VL;
E1VL << e1VL;
E2VL << e2VL;
TString s0 = S0.str();
TString s1 = S1.str();
TString s2 = S2.str();
TString se0 = E0.str();
TString se1 = E1.str();
TString se2 = E2.str();
TString s0VL = S0VL.str();
TString s1VL = S1VL.str();
TString s2VL = S2VL.str();
TString se0VL = E0VL.str();
TString se1VL = E1VL.str();
TString se2VL = E2VL.str();
TString tt1 = "("+s0+"*z2l1Pt/z2l1Pt+"+s1+"*exp(z2l1Pt*"+s2+"))";
TString tt2 = "("+s0+"*z2l2Pt/z2l2Pt+"+s1+"*exp(z2l2Pt*"+s2+"))";
TString tte1 = "("+se0+"^2*z2l1Pt/z2l1Pt+("+se1+"^2+"+s1+"^2*z2l1Pt^2*"+se2+"^2)*exp(2*z2l1Pt*"+s2+"))";
TString tte2 = "("+se0+"^2*z2l2Pt/z2l2Pt+("+se1+"^2+"+s1+"^2*z2l2Pt^2*"+se2+"^2)*exp(2*z2l2Pt*"+s2+"))";
TString et = "("+s0VL+"*z2l2Pt/z2l2Pt+"+s1VL+"*exp(z2l2Pt*"+s2VL+"))";
TString mt = "("+s0VL+"*z2l2Pt/z2l2Pt+"+s1VL+"*exp(z2l2Pt*"+s2VL+"))";
TString ete = "("+se0VL+"^2*z2l2Pt/z2l2Pt+("+se1VL+"^2+"+s1VL+"^2*z2l2Pt^2*"+se2VL+"^2)*exp(2*z2l2Pt*"+s2VL+"))";
TString mte = "("+se0VL+"^2*z2l2Pt/z2l2Pt+("+se1VL+"^2+"+s1VL+"^2*z2l2Pt^2*"+se2VL+"^2)*exp(2*z2l2Pt*"+s2VL+"))";

/////////////////Apply fit to individual channels////////////////////////////////////
eventTree->Draw("1>>ll(1,1,2)","("+LMuZ+STTZcuts+")*"+tt1+"*"+tt2+"/(1-"+tt1+"*"+tt2+")");
double llv = ll->GetBinContent(1);
eventTree->Draw("1>>lle(1,1,2)","("+LMuZ+STTZcuts+")*"+tt1+"^2*"+tt2+"^2");
double llev1 = lle->GetBinContent(1);
eventTree->Draw("1>>lle(1,1,2)","("+LMuZ+STTZcuts+")*"+tte1+"*"+tt2+"");
double llev2 = lle->GetBinContent(1);
eventTree->Draw("1>>lle(1,1,2)","("+LMuZ+STTZcuts+")*"+tt1+"*"+tte2+"");
double llev3 = lle->GetBinContent(1);
double llev = sqrt(llev1+llev2*llev2+llev3*llev3);
cout << "Z+Jets Background for MMTT = " << llv << " +- " << llev << endl;
e->cd();
eleEleTauTauEventTreeID->cd();
eventTree->Draw("1>>ll(1,1,2)","("+LEleZ+STTZcuts+")*"+tt1+"*"+tt2+"/(1-"+tt1+"*"+tt2+")");
double llv = ll->GetBinContent(1);
eventTree->Draw("1>>lle(1,1,2)","("+LEleZ+STTZcuts+")*"+tt1+"^2*"+tt2+"^2");
double llev1 = lle->GetBinContent(1);
eventTree->Draw("1>>lle(1,1,2)","("+LEleZ+STTZcuts+")*"+tte1+"*"+tt2+"");
double llev2 = lle->GetBinContent(1);
eventTree->Draw("1>>lle(1,1,2)","("+LEleZ+STTZcuts+")*"+tt1+"*"+tte2+"");
double llev3 = lle->GetBinContent(1);
double llev = sqrt(llev1+llev2*llev2+llev3*llev3);
cout << "Z+Jets Background for EETT = " << llv << " +- " << llev << endl;
e->cd();
eleEleEleTauEventTreeID->cd();
eventTree->Draw("1>>l(1,1,2)","("+LEleZ+SETZcuts+")*"+et+"/(1-"+et+")");
double lv = l->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LEleZ+SETZcuts+")*"+et+"^2");
double ler1 = le->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LEleZ+SETZcuts+")*"+ete+"");
double ler2 = le->GetBinContent(1);
double ler = sqrt(ler1+ler2*ler2);
cout << "Z+Jets Background for EEET = " << lv << " +- " << ler << endl;
m->cd();
muMuEleTauEventTreeID->cd();
eventTree->Draw("1>>l(1,1,2)","("+LMuZ+SETZcuts+")*"+et+"/(1-"+et+")");
double lv = l->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LMuZ+SETZcuts+")*"+et+"^2");
double ler1 = le->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LMuZ+SETZcuts+")*"+ete+"");
double ler2 = le->GetBinContent(1);
double ler = sqrt(ler1+ler2*ler2);
cout << "Z+Jets Background for MMET = " << lv << " +- " << ler << endl;
m->cd();
muMuMuTauEventTreeID->cd();
eventTree->Draw("1>>l(1,1,2)","("+LMuZ+SMTZcuts+")*"+mt+"/(1-"+mt+")");
double lv = l->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LMuZ+SMTZcuts+")*"+mt+"^2");
double ler1 = le->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LMuZ+SMTZcuts+")*"+mte+"");
double ler2 = le->GetBinContent(1);
double ler = sqrt(ler1+ler2*ler2);
cout << "Z+Jets Background for MMMT = " << lv << " +- " << ler << endl;
e->cd();
eleEleMuTauEventTreeID->cd();
eventTree->Draw("1>>l(1,1,2)","("+LEleZ+SMTZcuts+")*"+mt+"/(1-"+mt+")");
double lv = l->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LEleZ+SMTZcuts+")*"+mt+"^2");
double ler1 = le->GetBinContent(1);
eventTree->Draw("1>>le(1,1,2)","("+LEleZ+SMTZcuts+")*"+mte+"");
double ler2 = le->GetBinContent(1);
double ler = sqrt(ler1+ler2*ler2);
cout << "Z+Jets Background for EEMT = " << lv << " +- " << ler << endl;


}